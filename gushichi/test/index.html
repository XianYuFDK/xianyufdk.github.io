<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古诗词搜索 - 测试页面</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .test-results {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 500px;
            overflow: auto;
        }
        .test-section {
            margin-bottom: 2rem;
        }
        .progress {
            height: 30px;
        }
        .btn-test {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <header class="mb-5">
            <h1>古诗词搜索 - 测试页面</h1>
            <p class="lead">用于测试古诗词搜索功能和数据加载</p>
        </header>

        <nav class="mb-4">
            <a href="../index.html" class="btn btn-outline-primary">返回主页</a>
        </nav>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">测试选项</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="test-data-source" class="form-label">数据源</label>
                            <select class="form-select" id="test-data-source">
                                <option value="local" selected>本地数据</option>
                                <option value="remote">远程数据</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="test-cache" checked>
                            <label class="form-check-label" for="test-cache">使用缓存</label>
                        </div>
                        
                        <div class="btn-group-vertical w-100" role="group">
                            <button id="btn-test-config" class="btn btn-test btn-primary">测试配置</button>
                            <button id="btn-test-data-load" class="btn btn-test btn-primary">测试数据加载</button>
                            <button id="btn-test-search" class="btn btn-test btn-primary">测试搜索功能</button>
                            <button id="btn-test-all" class="btn btn-test btn-success">运行所有测试</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">快速搜索测试</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="test-query" class="form-label">关键词</label>
                            <input type="text" class="form-control" id="test-query" value="春晓">
                        </div>
                        
                        <div class="mb-3">
                            <label for="test-category" class="form-label">分类</label>
                            <select class="form-select" id="test-category">
                                <option value="all">所有</option>
                                <option value="tang" selected>唐诗</option>
                                <option value="song">宋词</option>
                                <option value="shi">诗经</option>
                                <option value="lunyu">论语</option>
                                <option value="yuan">元曲</option>
                                <option value="caocao">曹操诗集</option>
                            </select>
                        </div>
                        
                        <button id="btn-quick-search" class="btn btn-primary w-100">搜索</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="test-section">
                    <h3>测试结果</h3>
                    <div class="progress mb-3">
                        <div id="test-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <div id="test-results" class="test-results">
                        准备运行测试...
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>搜索结果</h3>
                    <div id="search-results" class="test-results">
                        运行搜索测试查看结果...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/dataLoader.js"></script>
    <script src="../js/jinrishiciAPI.js"></script>
    <script src="../js/gushiciOneAPI.js"></script>
    <script src="../js/gushiwenAPI.js"></script>
    <script src="../js/search.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // 测试工具函数
        const TestUtils = {
            log: function(message) {
                const results = document.getElementById('test-results');
                const timestamp = new Date().toLocaleTimeString();
                results.textContent += `[${timestamp}] ${message}\n`;
                results.scrollTop = results.scrollHeight;
            },
            
            clearLog: function() {
                document.getElementById('test-results').textContent = '';
            },
            
            updateProgress: function(percent) {
                const progress = document.getElementById('test-progress');
                progress.style.width = `${percent}%`;
                progress.textContent = `${percent}%`;
                progress.setAttribute('aria-valuenow', percent);
            },
            
            displaySearchResults: function(results) {
                const container = document.getElementById('search-results');
                
                if (!results || results.length === 0) {
                    container.textContent = '未找到结果';
                    return;
                }
                
                let output = `找到 ${results.length} 条结果:\n\n`;
                
                results.slice(0, 10).forEach((item, index) => {
                    const title = item.title || item.rhythmic || '无题';
                    const author = item.author || item.poet || '佚名';
                    const dynasty = item.dynasty || '';
                    
                    let content = '';
                    if (item.paragraphs && item.paragraphs.length > 0) {
                        content = item.paragraphs.slice(0, 3).join('\n');
                    } else if (item.content) {
                        content = Array.isArray(item.content) ? 
                            item.content.slice(0, 3).join('\n') : 
                            item.content.substring(0, 100);
                    } else if (item.chapter) {
                        content = item.chapter.substring(0, 100);
                    }
                    
                    output += `------- ${index + 1} -------\n`;
                    output += `标题: ${title}\n`;
                    output += `作者: ${dynasty ? dynasty + ' · ' : ''}${author}\n`;
                    output += `内容:\n${content}\n\n`;
                });
                
                if (results.length > 10) {
                    output += `......还有 ${results.length - 10} 条结果未显示\n`;
                }
                
                container.textContent = output;
            }
        };
        
        // 测试配置
        function testConfig() {
            TestUtils.clearLog();
            TestUtils.log('===== 测试配置 =====');
            
            // 获取测试设置
            const useLocalData = document.getElementById('test-data-source').value === 'local';
            const useCache = document.getElementById('test-cache').checked;
            
            // 临时保存原始配置
            const originalLocalData = CONFIG.dataSource.useLocalData;
            const originalCache = CONFIG.cache.enabled;
            
            // 应用测试设置
            CONFIG.dataSource.useLocalData = useLocalData;
            CONFIG.cache.enabled = useCache;
            
            TestUtils.log('应用测试设置:');
            TestUtils.log(`- 使用本地数据: ${CONFIG.dataSource.useLocalData}`);
            TestUtils.log(`- 本地数据路径: ${CONFIG.dataSource.localPath}`);
            TestUtils.log(`- 使用缓存: ${CONFIG.cache.enabled}`);
            TestUtils.log('');
            
            TestUtils.log('数据源配置:');
            TestUtils.log(`- 主数据源: ${CONFIG.dataSource.baseUrl}`);
            TestUtils.log(`- 备用数据源: ${CONFIG.dataSource.fallbackUrls.join(', ')}`);
            TestUtils.log('');
            
            TestUtils.log('诗词数据映射:');
            for (const [category, info] of Object.entries(CONFIG.dataSource.poetryMap)) {
                TestUtils.log(`- ${category}: ${info.path} (${info.files.join(', ')})`);
            }
            
            TestUtils.log('');
            TestUtils.log('配置测试完成');
            
            // 如果设置已更改，提醒用户
            if (originalLocalData !== useLocalData || originalCache !== useCache) {
                TestUtils.log('注意: 配置已更改，请刷新页面恢复原始设置');
            }
            
            return true;
        }
        
        // 测试数据加载
        async function testDataLoad() {
            TestUtils.clearLog();
            TestUtils.log('===== 测试数据加载 =====');
            
            // 获取测试设置
            const useLocalData = document.getElementById('test-data-source').value === 'local';
            const useCache = document.getElementById('test-cache').checked;
            
            // 应用测试设置
            CONFIG.dataSource.useLocalData = useLocalData;
            CONFIG.cache.enabled = useCache;
            
            TestUtils.log(`使用本地数据: ${CONFIG.dataSource.useLocalData}`);
            TestUtils.log(`使用缓存: ${CONFIG.cache.enabled}`);
            TestUtils.log('');
            
            // 初始化数据加载器
            const loader = new DataLoader(CONFIG);
            
            // 测试各个类别的数据加载
            const categories = Object.keys(CONFIG.dataSource.poetryMap);
            let success = 0;
            
            TestUtils.updateProgress(0);
            
            for (let i = 0; i < categories.length; i++) {
                const category = categories[i];
                TestUtils.log(`正在加载 ${category} 数据...`);
                
                try {
                    const data = await loader.fetchFromGitHub(category);
                    const count = data.length;
                    
                    TestUtils.log(`✓ 成功加载 ${count} 条 ${category} 数据`);
                    if (count > 0) {
                        const sample = data[0];
                        TestUtils.log(`示例数据: ${JSON.stringify(sample, null, 2).substring(0, 200)}...`);
                    }
                    
                    success++;
                } catch (error) {
                    TestUtils.log(`✗ 加载 ${category} 数据失败: ${error.message}`);
                }
                
                TestUtils.log('');
                
                // 更新进度
                const progress = Math.round((i + 1) / categories.length * 100);
                TestUtils.updateProgress(progress);
            }
            
            TestUtils.log(`数据加载测试完成: ${success}/${categories.length} 成功`);
            
            return success === categories.length;
        }
        
        // 测试搜索功能
        async function testSearch() {
            TestUtils.clearLog();
            TestUtils.log('===== 测试搜索功能 =====');
            
            // 获取测试设置
            const useLocalData = document.getElementById('test-data-source').value === 'local';
            const useCache = document.getElementById('test-cache').checked;
            
            // 应用测试设置
            CONFIG.dataSource.useLocalData = useLocalData;
            CONFIG.cache.enabled = useCache;
            
            TestUtils.log(`使用本地数据: ${CONFIG.dataSource.useLocalData}`);
            TestUtils.log(`使用缓存: ${CONFIG.cache.enabled}`);
            TestUtils.log('');
            
            // 测试搜索
            const testQueries = [
                { query: '春晓', category: 'tang', expected: '孟浩然' },
                { query: '学而', category: 'lunyu', expected: '学而篇' },
                { query: '关雎', category: 'shi', expected: '关雎' }
            ];
            
            let success = 0;
            TestUtils.updateProgress(0);
            
            for (let i = 0; i < testQueries.length; i++) {
                const test = testQueries[i];
                TestUtils.log(`测试搜索: "${test.query}" (分类: ${test.category})`);
                
                try {
                    // 设置搜索选项
                    const options = {
                        category: test.category,
                        searchTitle: true,
                        searchAuthor: true,
                        searchContent: true,
                        searchTags: true
                    };
                    
                    // 执行搜索
                    TestUtils.log('正在搜索...');
                    const results = await apiManager.searchPoems(test.query, options);
                    
                    // 输出结果
                    TestUtils.log(`找到 ${results.length} 条结果`);
                    
                    if (results.length > 0) {
                        TestUtils.log('前三条结果:');
                        results.slice(0, 3).forEach((item, index) => {
                            const title = item.title || item.rhythmic || '无题';
                            const author = item.author || item.poet || '佚名';
                            const preview = item.paragraphs ? 
                                item.paragraphs.slice(0, 1).join('') : 
                                (item.content ? item.content.slice(0, 20) : '');
                            
                            TestUtils.log(`[${index + 1}] ${title} - ${author}: ${preview}...`);
                        });
                        
                        // 检查预期结果
                        const hasExpected = results.some(item => {
                            const content = JSON.stringify(item);
                            return content.includes(test.expected);
                        });
                        
                        TestUtils.log(`测试结果: ${hasExpected ? '✓ 通过' : '✗ 失败'} (预期包含 "${test.expected}")`);
                        
                        if (hasExpected) success++;
                    } else {
                        TestUtils.log(`测试结果: ✗ 失败 (未找到结果，预期包含 "${test.expected}")`);
                    }
                } catch (error) {
                    TestUtils.log(`测试错误: ${error.message}`);
                    TestUtils.log(`测试结果: ✗ 失败 (发生错误)`);
                }
                
                TestUtils.log('');
                
                // 更新进度
                const progress = Math.round((i + 1) / testQueries.length * 100);
                TestUtils.updateProgress(progress);
            }
            
            TestUtils.log(`搜索测试完成: ${success}/${testQueries.length} 成功`);
            
            return success === testQueries.length;
        }
        
        // 运行所有测试
        async function runAllTests() {
            TestUtils.clearLog();
            TestUtils.log('===== 运行所有测试 =====');
            
            TestUtils.log('1. 测试配置');
            const configResult = testConfig();
            
            TestUtils.log('\n2. 测试数据加载');
            const dataResult = await testDataLoad();
            
            TestUtils.log('\n3. 测试搜索功能');
            const searchResult = await testSearch();
            
            TestUtils.log('\n===== 测试总结 =====');
            TestUtils.log(`配置测试: ${configResult ? '✓ 通过' : '✗ 失败'}`);
            TestUtils.log(`数据加载测试: ${dataResult ? '✓ 通过' : '✗ 失败'}`);
            TestUtils.log(`搜索功能测试: ${searchResult ? '✓ 通过' : '✗ 失败'}`);
            
            const allPassed = configResult && dataResult && searchResult;
            TestUtils.log(`\n总体结果: ${allPassed ? '✓ 所有测试通过' : '✗ 测试存在失败'}`);
            
            return allPassed;
        }
        
        // 执行快速搜索
        async function performQuickSearch() {
            const query = document.getElementById('test-query').value.trim();
            const category = document.getElementById('test-category').value;
            
            if (!query) {
                alert('请输入搜索关键词');
                return;
            }
            
            document.getElementById('search-results').textContent = '正在搜索...';
            
            try {
                const options = {
                    category: category,
                    searchTitle: true,
                    searchAuthor: true,
                    searchContent: true,
                    searchTags: true
                };
                
                const results = await apiManager.searchPoems(query, options);
                TestUtils.displaySearchResults(results);
            } catch (error) {
                document.getElementById('search-results').textContent = `搜索出错: ${error.message}`;
            }
        }
        
        // 注册事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('btn-test-config').addEventListener('click', testConfig);
            document.getElementById('btn-test-data-load').addEventListener('click', testDataLoad);
            document.getElementById('btn-test-search').addEventListener('click', testSearch);
            document.getElementById('btn-test-all').addEventListener('click', runAllTests);
            document.getElementById('btn-quick-search').addEventListener('click', performQuickSearch);
        });
    </script>
</body>
</html>
